<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:VideoDedupe.App.ViewModels"
        x:Class="VideoDedupe.App.Views.MainWindow"
        x:DataType="vm:MainViewModel"
        Width="1200"
        Height="750"
        Title="VideoDedupe">

  <Window.DataContext>
    <vm:MainViewModel/>
  </Window.DataContext>

  <Grid RowDefinitions="Auto,*"
        ColumnDefinitions="380,*"
        Margin="12">

    <!-- Top Bar -->
    <Border Grid.Row="0"
            Grid.ColumnSpan="2"
            Padding="10"
            CornerRadius="10"
            Background="#1E1E1E">

      <StackPanel Orientation="Horizontal" Spacing="10">

        <TextBlock Foreground="White"
                   VerticalAlignment="Center"
                   Text="DB:"/>
        <Button Content="Scan Index"
                Command="{Binding RunScanIndexCommand}"
                IsEnabled="{Binding !IsBusy}"/>

        <Button Content="Dupe Build"
                Command="{Binding RunDupeBuildCommand}"
                IsEnabled="{Binding !IsBusy}"/>
        <TextBox Width="320"
                 Text="{Binding DbPath}"/>

        <Button Content="Pick DB…"
                Command="{Binding PickDbCommand}"
                IsEnabled="{Binding !IsBusy}"/>
        
        <TextBlock Foreground="White" VerticalAlignment="Center" Text="Quarantine:"/>
        <TextBox Width="260" Text="{Binding QuarantineRoot}"/>
        <Button Content="Keep Best"
                Command="{Binding KeepBestInSelectedGroupCommand}"
                IsEnabled="{Binding !IsBusy}"/>

        <Button Content="Load Groups"
                Command="{Binding LoadGroupsCommand}"
                IsEnabled="{Binding !IsBusy}"/>

        <Button Content="Load Thumbnails"
                Command="{Binding LoadThumbnailsCommand}"
                IsEnabled="{Binding !IsBusy}"/>

        <TextBlock Foreground="#CFCFCF"
                   VerticalAlignment="Center"
                   Text="{Binding Status}"/>

      </StackPanel>
    </Border>

    <!-- LEFT: Duplicate Groups -->
    <Border Grid.Row="1"
           Grid.Column="0"
           Padding="10"
           CornerRadius="10"
           Background="#121212"
           Margin="0,12,12,0">

      <Grid RowDefinitions="Auto,Auto,*" >

        <!-- Roots header -->
        <TextBlock Grid.Row="0"
           Foreground="White"
           FontSize="16"
           Text="Scan Roots"
           Margin="0,0,0,6"/>

        <Grid Grid.Row="1"
              ColumnDefinitions="*,*"
              RowDefinitions="Auto,Auto,Auto"
              ColumnSpacing="10"
              Margin="0,0,0,10">

          <!-- Buttons -->
          <StackPanel Grid.Row="0" Grid.ColumnSpan="2"
                      Orientation="Horizontal" Spacing="8">
            <Button Content="Load Roots"
                    Command="{Binding LoadRootsCommand}"
                    IsEnabled="{Binding !IsBusy}"/>
            <Button Content="Add Root…"
                    Command="{Binding AddRootCommand}"
                    IsEnabled="{Binding !IsBusy}"/>
            <Button Content="Save Options"
                    Command="{Binding SaveRootOptionsCommand}"
                    IsEnabled="{Binding !IsBusy}"/>
          </StackPanel>

          <!-- Roots list -->
          <Border Grid.Row="1" Grid.Column="0"
                  Background="#1E1E1E"
                  CornerRadius="8"
                  Padding="6">
            <ListBox ItemsSource="{Binding Roots}"
                     SelectedItem="{Binding SelectedRoot}">
              <ListBox.ItemTemplate>
                <DataTemplate x:DataType="vm:RootVm">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <CheckBox IsChecked="{Binding IsEnabled}"/>
                    <TextBlock Text="{Binding Path}" TextWrapping="Wrap"/>
                  </StackPanel>
                </DataTemplate>
              </ListBox.ItemTemplate>
            </ListBox>
          </Border>

          <!-- Selected root options -->
          <Border Grid.Row="1" Grid.Column="1"
                  Background="#1E1E1E"
                  CornerRadius="8"
                  Padding="8">
            <StackPanel Spacing="8">

              <TextBlock Foreground="White"
                         FontWeight="Bold"
                         Text="Selected Root"/>

              <TextBlock Foreground="#CFCFCF"
                         Text="{Binding SelectedRoot.Path}"
                         TextWrapping="Wrap"/>

              <CheckBox Content="Include subfolders"
                        IsChecked="{Binding SelectedRoot.IncludeSubdirs}"/>

              <TextBox Watermark="ExcludeText (MVP): temp;cache;whatsapp"
                       Text="{Binding SelectedRoot.ExcludeText}"/>

            </StackPanel>
          </Border>

          <!-- Hint when nothing selected -->
          <TextBlock Grid.Row="2" Grid.ColumnSpan="2"
                     Foreground="#CFCFCF"
                     Text="Select a root to edit options."
                     IsVisible="{Binding SelectedRoot, Converter={x:Null}}"/>
        </Grid>

        <!-- Groups header + filter (optional) + list -->
        <StackPanel Grid.Row="2">
          <TextBlock Foreground="White"
                     FontSize="16"
                     Text="Duplicate Groups"
                     Margin="0,0,0,8"/>

          <ScrollViewer VerticalScrollBarVisibility="Auto"
                        HorizontalScrollBarVisibility="Disabled">
            <ListBox ItemsSource="{Binding FilteredGroups}"
                     SelectedItem="{Binding SelectedGroup}">
              <ListBox.ItemTemplate>
                <DataTemplate x:DataType="vm:GroupVm">
                  <Border Padding="8"
                          Margin="0,0,0,8"
                          CornerRadius="8"
                          Background="#1E1E1E">
                    <StackPanel>
                      <TextBlock Foreground="White" Text="{Binding Title}"/>
                      <TextBlock Foreground="#CFCFCF" Text="{Binding Algorithm}"/>
                      <TextBlock Foreground="#CFCFCF" Text="{Binding Frames, StringFormat=frames: {0}}"/>
                      <TextBlock Foreground="#CFCFCF" Text="{Binding CreatedUtc}"/>
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ListBox.ItemTemplate>
            </ListBox>
          </ScrollViewer>
        </StackPanel>

      </Grid>
    </Border>
    <!-- RIGHT: Group Detail -->
    <Border Grid.Row="1"
            Grid.Column="1"
            Padding="10"
            CornerRadius="10"
            Background="#121212"
            Margin="0,12,0,0">

      <StackPanel>

        <TextBlock Foreground="White"
                   FontSize="16"
                   Margin="0,0,0,8"
                   Text="{Binding SelectedGroup.Title}"/>

        <ScrollViewer>
          <ItemsControl ItemsSource="{Binding SelectedGroup.Members}">

            <ItemsControl.ItemTemplate>
              <DataTemplate x:DataType="vm:MemberVm">
                <Border Padding="10"
                        Margin="0,0,0,10"
                        CornerRadius="10"
                        Background="#1E1E1E"
                        DoubleTapped="Member_DoubleTapped">
                  <Border.ContextMenu>
                    <ContextMenu>
                      <MenuItem Header="Open"
                                Command="{Binding $parent[Window].DataContext.OpenFileCommand}"
                                CommandParameter="{Binding .}" />
                      <MenuItem Header="Show in Explorer"
                                Command="{Binding $parent[Window].DataContext.ShowInExplorerCommand}"
                                CommandParameter="{Binding .}" />
                      <MenuItem Header="Copy Path"
                                Command="{Binding $parent[Window].DataContext.CopyPathCommand}"
                                CommandParameter="{Binding .}" />
                    </ContextMenu>
                  </Border.ContextMenu>
                  <StackPanel Spacing="6">

                    <!-- BEST marker -->
                    <TextBlock Foreground="#FFD700"
                               Text="BEST"
                               FontWeight="Bold"
                               IsVisible="{Binding IsBest}"/>

                    <!-- Thumbnails -->
                    <StackPanel Orientation="Horizontal" Spacing="10">

                      <Border Width="160" Height="90" Background="#0E0E0E" CornerRadius="8">
                        <Image Source="{Binding Thumb20}" Stretch="UniformToFill"/>
                      </Border>

                      <Border Width="160" Height="90" Background="#0E0E0E" CornerRadius="8">
                        <Image Source="{Binding Thumb50}" Stretch="UniformToFill"/>
                      </Border>

                      <Border Width="160" Height="90" Background="#0E0E0E" CornerRadius="8">
                        <Image Source="{Binding Thumb80}" Stretch="UniformToFill"/>
                      </Border>

                    </StackPanel>

                    <TextBlock Foreground="#AAAAAA"
                               Text="Loading thumbnails…"
                               IsVisible="{Binding ThumbsLoading}"/>

                    <!-- File Info -->
                    <TextBlock Foreground="White"
                               Text="{Binding Path}"
                               TextWrapping="Wrap"/>

                    <StackPanel Orientation="Horizontal" Spacing="10">
                      <TextBlock Foreground="#CFCFCF"
                                 Text="{Binding AvgDist, StringFormat=avgDist: {0:F1}}"/>

                      <TextBlock Foreground="#CFCFCF"
                                 Text="{Binding Width}"/>

                      <TextBlock Foreground="#CFCFCF" Text="x"/>

                      <TextBlock Foreground="#CFCFCF"
                                 Text="{Binding Height}"/>

                      <TextBlock Foreground="#CFCFCF"
                                 Text="{Binding DurationSec, StringFormat={}{0:F2}s}"/>

                      <TextBlock Foreground="#CFCFCF"
                                 Text="{Binding SizeBytes, StringFormat={}{0} bytes}"/>

                      <TextBlock Foreground="#CFCFCF"
                                 Text="{Binding VideoCodec}"/>
                    </StackPanel>
                   
                    <StackPanel Orientation="Horizontal" Spacing="10">
                      <Button Content="Keep"
                              Command="{Binding $parent[Window].DataContext.MarkKeepCommand}"
                              CommandParameter="{Binding .}" />
                      <Button Content="Quarantine"
                              Command="{Binding $parent[Window].DataContext.QuarantineCommand}"
                              CommandParameter="{Binding .}" />
                      <TextBlock Foreground="#CFCFCF" Text="{Binding Decision, StringFormat=decision: {0}}"/>
                      <TextBlock Foreground="#CFCFCF" Text="{Binding Suggested, StringFormat=suggested: {0}}"
                                 IsVisible="{Binding Suggested}"/>
                    </StackPanel>


                  </StackPanel>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>

          </ItemsControl>
        </ScrollViewer>

      </StackPanel>
    </Border>

  </Grid>
</Window>
