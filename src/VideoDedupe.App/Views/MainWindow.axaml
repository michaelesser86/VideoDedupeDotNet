<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:VideoDedupe.App.ViewModels"
        x:Class="VideoDedupe.App.Views.MainWindow"
        x:DataType="vm:MainViewModel"
        Width="1320"
        Height="820"
        MinWidth="1100"
        MinHeight="700"
        Title="VideoDedupe">

  <Window.DataContext>
    <vm:MainViewModel/>
  </Window.DataContext>

  <!-- Root layout -->
  <Grid RowDefinitions="Auto,*"
        Margin="14"
        RowSpacing="12">

    <!-- Top Bar -->
    <Border Grid.Row="0"
            CornerRadius="12"
            Padding="12">
      <DockPanel LastChildFill="True">

        <!-- Left: DB + actions -->
        <WrapPanel DockPanel.Dock="Left"
                   VerticalAlignment="Center"
                   HorizontalAlignment="Left"
                   ItemSpacing="10">

          <TextBlock VerticalAlignment="Center"
                     FontWeight="SemiBold"
                     Text="Database:"/>

          <TextBox Width="420"
                   Text="{Binding DbPath}"/>

          <Button Content="Pick DB…"
                  Command="{Binding PickDbCommand}"
                  IsEnabled="{Binding !IsBusy}"/>

          <Separator Width="10"/>

          <Button Content="Scan Index"
                  Command="{Binding RunScanIndexCommand}"
                  IsEnabled="{Binding !IsBusy}"/>

          <Button Content="Dupe Build"
                  Command="{Binding RunDupeBuildCommand}"
                  IsEnabled="{Binding !IsBusy}"/>

          <Separator Width="10"/>

          <Button Content="Load Roots"
                  Command="{Binding LoadRootsCommand}"
                  IsEnabled="{Binding !IsBusy}"/>

          <Button Content="Load Groups"
                  Command="{Binding LoadGroupsCommand}"
                  IsEnabled="{Binding !IsBusy}"/>
        </WrapPanel>

        <!-- Right: status -->
        <TextBlock DockPanel.Dock="Right"
                   VerticalAlignment="Center"
                   TextAlignment="Right"
                   TextTrimming="CharacterEllipsis"
                   MaxWidth="420"
                   Opacity="0.85"
                   Text="{Binding Status}"/>
      </DockPanel>
    </Border>

    <!-- Main Content -->
    <Grid Grid.Row="1"
          ColumnDefinitions="460,*"
          ColumnSpacing="12">

      <!-- LEFT PANE -->
      <Border Grid.Column="0"
              CornerRadius="12"
              Padding="12">
        <Grid RowDefinitions="Auto,*"
              RowSpacing="10">

          <TextBlock Grid.Row="0"
                     FontSize="18"
                     FontWeight="SemiBold"
                     Text="Workspace"/>

          <TabControl Grid.Row="1">

            <!-- ROOTS TAB -->
            <TabItem Header="Roots">
              <Grid RowDefinitions="Auto,Auto,*"
                    RowSpacing="10"
                    Margin="2">

                <!-- Buttons -->
                <WrapPanel Grid.Row="0"
                           ItemSpacing="10">

                  <Button Content="Add Root…"
                          Command="{Binding AddRootCommand}"
                          IsEnabled="{Binding !IsBusy}"/>

                  <Button Content="Remove Selected"
                          Command="{Binding RemoveSelectedRootCommand}"
                          IsEnabled="{Binding SelectedRoot}"/>

                  <Button Content="Save Enabled"
                          Command="{Binding SaveRootEnabledCommand}"
                          IsEnabled="{Binding !IsBusy}"/>

                  <Button Content="Save Options"
                          Command="{Binding SaveRootOptionsCommand}"
                          IsEnabled="{Binding SelectedRoot}"/>
                </WrapPanel>

                <!-- Manual path add (keep it – very useful) -->
                <WrapPanel Grid.Row="1"
                           ItemSpacing="10">
                  <TextBox Width="300"
                           Watermark="Paste folder path (e.g. D:\Videos)"
                           Text="{Binding NewRootPath}"/>
                  <Button Content="Add Path"
                          Command="{Binding AddRootFromTextCommand}"
                          IsEnabled="{Binding !IsBusy}"/>
                </WrapPanel>

                <!-- Roots list + details -->
                <Grid Grid.Row="2"
                      ColumnDefinitions="*,*"
                      ColumnSpacing="10">

                  <!-- list -->
                  <Border Grid.Column="0"
                          CornerRadius="10"
                          Padding="8">
                    <DockPanel LastChildFill="True">

                      <TextBlock DockPanel.Dock="Top"
                                 FontWeight="SemiBold"
                                 Margin="0,0,0,6"
                                 Text="Roots"/>

                      <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ListBox ItemsSource="{Binding Roots}"
                                 SelectedItem="{Binding SelectedRoot}">
                          <ListBox.ItemTemplate>
                            <DataTemplate x:DataType="vm:RootVm">
                              <Grid ColumnDefinitions="Auto,*"
                                    ColumnSpacing="8">
                                <CheckBox Grid.Column="0"
                                          VerticalAlignment="Center"
                                          IsChecked="{Binding IsEnabled}"/>
                                <TextBlock Grid.Column="1"
                                           Text="{Binding Path}"
                                           TextWrapping="Wrap"/>
                              </Grid>
                            </DataTemplate>
                          </ListBox.ItemTemplate>
                        </ListBox>
                      </ScrollViewer>

                    </DockPanel>
                  </Border>

                  <!-- details -->
                  <Border Grid.Column="1"
                          CornerRadius="10"
                          Padding="10">
                    <StackPanel Spacing="10">
                      <TextBlock FontWeight="SemiBold"
                                 Text="Selected root"/>

                      <TextBlock Opacity="0.85"
                                 TextWrapping="Wrap"
                                 Text="{Binding SelectedRoot.Path}"/>

                      <CheckBox Content="Include subfolders"
                                IsChecked="{Binding SelectedRoot.IncludeSubdirs}"/>

                      <TextBlock Opacity="0.85"
                                 Text="Exclude (MVP): semicolon separated tokens. Example: temp;cache;whatsapp"/>

                      <TextBox TextWrapping="Wrap"
                               AcceptsReturn="True"
                               MinHeight="72"
                               Text="{Binding SelectedRoot.ExcludeText}"/>
                    </StackPanel>
                  </Border>

                </Grid>
              </Grid>
            </TabItem>

            <!-- GROUPS TAB -->
            <TabItem Header="Groups">
              <Grid RowDefinitions="Auto,*"
                    RowSpacing="10"
                    Margin="2">

                <Grid Grid.Row="0"
                      ColumnDefinitions="*,Auto"
                      ColumnSpacing="10">

                  <TextBox Grid.Column="0"
                           Watermark="Filter groups by path contains…"
                           Text="{Binding GroupFilter}"/>

                  <ComboBox Grid.Column="1"
                            Width="160"
                            SelectedItem="{Binding GroupSort}">
                    <ComboBoxItem Content="SizeDesc"/>
                    <ComboBoxItem Content="Newest"/>
                  </ComboBox>
                </Grid>

                <Border Grid.Row="1"
                        CornerRadius="10"
                        Padding="8">
                  <ScrollViewer VerticalScrollBarVisibility="Auto"
                                HorizontalScrollBarVisibility="Disabled">
                    <ListBox ItemsSource="{Binding FilteredGroups}"
                             SelectedItem="{Binding SelectedGroup}">
                      <ListBox.ItemTemplate>
                        <DataTemplate x:DataType="vm:GroupVm">
                          <Border CornerRadius="10"
                                  Padding="10"
                                  Margin="0,0,0,8">
                            <StackPanel Spacing="4">
                              <TextBlock FontWeight="SemiBold"
                                         Text="{Binding Title}"/>
                              <TextBlock Opacity="0.85"
                                         Text="{Binding Algorithm}"/>
                              <TextBlock Opacity="0.85"
                                         Text="{Binding Frames, StringFormat=frames: {0}}"/>
                              <TextBlock Opacity="0.85"
                                         Text="{Binding CreatedUtc}"/>
                            </StackPanel>
                          </Border>
                        </DataTemplate>
                      </ListBox.ItemTemplate>
                    </ListBox>
                  </ScrollViewer>
                </Border>

              </Grid>
            </TabItem>

          </TabControl>
        </Grid>
      </Border>

      <!-- RIGHT PANE -->
      <Border Grid.Column="1"
              CornerRadius="12"
              Padding="12">
        <Grid RowDefinitions="Auto,*"
              RowSpacing="10">

          <StackPanel Grid.Row="0" Spacing="4">
            <TextBlock FontSize="18"
                       FontWeight="SemiBold"
                       Text="{Binding SelectedGroup.Title}"/>
            <TextBlock Opacity="0.85"
                       Text="Tip: Double-click a member to open. Right-click for menu."/>
          </StackPanel>

          <Border Grid.Row="1"
                  CornerRadius="10"
                  Padding="10">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
              <ItemsControl ItemsSource="{Binding SelectedGroup.Members}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="vm:MemberVm">

                    <Border CornerRadius="12"
                            Padding="12"
                            Margin="0,0,0,12"
                            DoubleTapped="Member_DoubleTapped">

                      <Border.ContextMenu>
                        <ContextMenu>
                          <MenuItem Header="Open"
                                    Command="{Binding $parent[Window].DataContext.OpenFileCommand}"
                                    CommandParameter="{Binding .}" />
                          <MenuItem Header="Show in Explorer"
                                    Command="{Binding $parent[Window].DataContext.ShowInExplorerCommand}"
                                    CommandParameter="{Binding .}" />
                          <MenuItem Header="Copy Path"
                                    Command="{Binding $parent[Window].DataContext.CopyPathCommand}"
                                    CommandParameter="{Binding .}" />
                        </ContextMenu>
                      </Border.ContextMenu>

                      <StackPanel Spacing="10">

                        <!-- Header row -->
                        <Grid ColumnDefinitions="Auto,*"
                              ColumnSpacing="10">
                          <TextBlock Grid.Column="0"
                                     Text="BEST"
                                     FontWeight="Bold"
                                     Opacity="0.95"
                                     IsVisible="{Binding IsBest}" />
                          <TextBlock Grid.Column="1"
                                     FontWeight="SemiBold"
                                     TextWrapping="Wrap"
                                     Text="{Binding Path}" />
                        </Grid>

                        <!-- Thumbs -->
                        <StackPanel Orientation="Horizontal" Spacing="10">
                          <Border Width="220" Height="124" CornerRadius="10" Padding="0">
                            <Image Source="{Binding Thumb20}" Stretch="UniformToFill"/>
                          </Border>
                          <Border Width="220" Height="124" CornerRadius="10" Padding="0">
                            <Image Source="{Binding Thumb50}" Stretch="UniformToFill"/>
                          </Border>
                          <Border Width="220" Height="124" CornerRadius="10" Padding="0">
                            <Image Source="{Binding Thumb80}" Stretch="UniformToFill"/>
                          </Border>
                        </StackPanel>

                        <TextBlock Opacity="0.85"
                                   Text="Loading thumbnails…"
                                   IsVisible="{Binding ThumbsLoading}"/>

                        <!-- Meta line -->
                        <WrapPanel ItemSpacing="14">
                          <TextBlock Opacity="0.85"
                                     Text="{Binding AvgDist, StringFormat=avgDist: {0:F1}}"/>
                          <TextBlock Opacity="0.85"
                                     Text="{Binding Width}"/>
                          <TextBlock Opacity="0.85" Text="x"/>
                          <TextBlock Opacity="0.85"
                                     Text="{Binding Height}"/>
                          <TextBlock Opacity="0.85"
                                     Text="{Binding DurationSec, StringFormat={}{0:F2}s}"/>
                          <TextBlock Opacity="0.85"
                                     Text="{Binding SizeBytes, StringFormat={}{0} bytes}"/>
                          <TextBlock Opacity="0.85"
                                     Text="{Binding VideoCodec}"/>
                        </WrapPanel>

                        <!-- Action row (optional buttons; context menu exists anyway) -->
                        <WrapPanel ItemSpacing="10">
                          <Button Content="Open"
                                  Command="{Binding $parent[Window].DataContext.OpenFileCommand}"
                                  CommandParameter="{Binding .}"/>
                          <Button Content="Explorer"
                                  Command="{Binding $parent[Window].DataContext.ShowInExplorerCommand}"
                                  CommandParameter="{Binding .}"/>
                          <Button Content="Copy Path"
                                  Command="{Binding $parent[Window].DataContext.CopyPathCommand}"
                                  CommandParameter="{Binding .}"/>
                        </WrapPanel>

                      </StackPanel>
                    </Border>

                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </Border>

        </Grid>
      </Border>

    </Grid>
  </Grid>
</Window>
